@{
    var viewModel = (Afdian.Action.ViewModels.AfdianViewModel)Model;
    const string meUserId = "e6bacc3e730d11ea857252540025c377";
    const string currentRepoPlanId = "cd7b3152731011eabcd452540025c377";

    // æ•°æ®é¢„å¤„ç†ï¼ˆä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼‰
    var validOrders = viewModel.Order.data.list
        .Where(m => m.plan_id == currentRepoPlanId)
        .ToList();

    var validSponsors = viewModel.Sponsor.data.list
        .Where(m => m.user.user_id != meUserId)
        .Join(validOrders,
            s => s.user.user_id,
            o => o.user_id,
            (s, _) => s)
        .Distinct()
        .ToList();

    // åˆ›å»ºæ’åºç»“æ„ä½“ï¼ˆå¢å¼ºç¨³å®šæ€§ï¼‰
    var sortedSponsors = validSponsors.Select(sponsor => {
        var userOrders = validOrders
            .Where(o => o.user_id == sponsor.user.user_id)
            .OrderByDescending(o => o.out_trade_no)
            .ToList();

        var lastOrder = userOrders.FirstOrDefault();
        DateTime lastOrderTime = DateTime.MinValue;
        
        if (lastOrder != null && lastOrder.out_trade_no.Length >= 14)
        {
            DateTime.TryParseExact(
                lastOrder.out_trade_no.Substring(0, 14),
                "yyyyMMddHHmmss",
                CultureInfo.InvariantCulture,
                DateTimeStyles.None,
                out lastOrderTime);
        }

        return new {
            Sponsor = sponsor,
            OrderCount = userOrders.Count,
            LastOrderTime = lastOrderTime,
            TotalAmount = userOrders.Sum(o => Convert.ToDouble(o.total_amount)),
            LastRemark = userOrders.LastOrDefault(o => !string.IsNullOrEmpty(o.remark))?.remark
        };
    })
    .OrderByDescending(x => x.TotalAmount)
    .ThenByDescending(x => x.LastOrderTime)
    .ToList();
}

<!-- å¤´åƒå±•ç¤ºåŒºï¼ˆå¢åŠ æ‡’åŠ è½½ä¼˜åŒ–ï¼‰ -->
<div align="center">
@foreach (var item in sortedSponsors)
{
    <a href="https://afdian.net/u/@item.Sponsor.user.user_id" 
       title="@item.Sponsor.user.name"
       target="_blank"
       rel="noopener noreferrer">
        <img src="@item.Sponsor.user.avatar?imageView2/1/w/120/h/120" 
             width="50" 
             height="50" 
             style="border-radius:50%;margin:5px;"
             alt="@item.Sponsor.user.name"
             loading="lazy">
    </a>
}
</div>

<details>
<summary>ğŸ‰ æ„Ÿè°¢è¿™äº›å¯çˆ±çš„èµåŠ©è€…ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
<br>

@foreach (var item in sortedSponsors)
{
    var remark = item.LastRemark ?? string.Empty;
    var displayRemark = remark.Length > 15 
        ? remark.Substring(0, 15) + "..." 
        : remark;

    <div style="margin-bottom: 8px; line-height: 1.5;">
        <a href="https://afdian.net/u/@item.Sponsor.user.user_id" 
           style="text-decoration: none;"
           target="_blank"
           rel="noopener noreferrer">
            <img src="@item.Sponsor.user.avatar?imageView2/1/w/40/h/40" 
                 width="20" 
                 height="20" 
                 style="vertical-align: middle; border-radius: 50%;"
                 alt="@item.Sponsor.user.name"
                 loading="lazy">
            <span style="color: #0366d6; font-weight: 500;">@item.Sponsor.user.name</span>
        </a>
        <span style="color: #586069; font-size: 0.9em;">
            (@item.OrderCount æ¬¡æ”¯æŒ)
            @if (!string.IsNullOrEmpty(remark))
            {
                <span title="@remark" style="cursor: help;">ğŸ“ @displayRemark</span>
            }
        </span>
    </div>
}
</details>
