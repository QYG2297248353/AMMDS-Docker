name: Build & Publish Docker Images

on:
  push:
    branches: [ release ]
  release:
    types: [ created ]
  workflow_dispatch:
    inputs:
      ref_name:
        description: '镜像标签（如 v1.6.10）'
        required: true
        default: 'v1.0.0'

env:
  REPO_DOCKERHUB: docker.io/qyg2297248353/ammds
  REPO_GHCR:      ghcr.io/qyg2297248353/ammds

jobs:
  # ------------------------
  # 1. 统一计算 tag
  # ------------------------
  set-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.calc_tag.outputs.tag }}
    steps:
      - id: calc_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.ref_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            BRANCH=${GITHUB_REF#refs/heads/}
            echo "tag=$BRANCH" >> $GITHUB_OUTPUT
          fi

  # ------------------------
  # 1.5 检查镜像是否已存在
  # ------------------------
  check-images:
    needs: set-tag
    runs-on: ubuntu-latest
    outputs:
      skip_build: ${{ steps.check.outputs.skip_build }}
    steps:
      - name: Login DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Check if arch images exist
        id: check
        run: |
          TAG=${{ needs.set-tag.outputs.tag }}
          AMD="${{ env.REPO_DOCKERHUB }}:$TAG-amd64"
          ARM="${{ env.REPO_DOCKERHUB }}:$TAG-arm64"

          AMD_OK=$(docker buildx imagetools inspect "$AMD" > /dev/null 2>&1 && echo yes || echo no)
          ARM_OK=$(docker buildx imagetools inspect "$ARM" > /dev/null 2>&1 && echo yes || echo no)

          if [[ "$AMD_OK" == "yes" && "$ARM_OK" == "yes" ]]; then
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

  # ------------------------
  # 2a. 构建 amd64（若 skip_build=false）
  # ------------------------
  build-amd64:
    needs: [ set-tag, check-images ]
    if: needs.check-images.outputs.skip_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: |
          git lfs install --skip-smudge
          git clone https://x-access-token:${{ secrets.GITHUBTOKEN }}@github.com/QYG2297248353/AMMDS.git source
          cd source && git lfs pull --exclude="*"
      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v2
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}
      - name: Build & push amd64
        uses: docker/build-push-action@v4
        with:
          context: ./source
          file: ./source/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REPO_DOCKERHUB }}:${{ needs.set-tag.outputs.tag }}-amd64
            ${{ env.REPO_GHCR }}:${{ needs.set-tag.outputs.tag }}-amd64

  # ------------------------
  # 2b. 构建 arm64（若 skip_build=false）
  # ------------------------
  build-arm64:
    needs: [ set-tag, check-images ]
    if: needs.check-images.outputs.skip_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: |
          git lfs install --skip-smudge
          git clone https://x-access-token:${{ secrets.GITHUBTOKEN }}@github.com/QYG2297248353/AMMDS.git source
          cd source && git lfs pull --exclude="*"
      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v2
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}
      - name: Build & push arm64
        uses: docker/build-push-action@v4
        with:
          context: ./source
          file: ./source/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.REPO_DOCKERHUB }}:${{ needs.set-tag.outputs.tag }}-arm64
            ${{ env.REPO_GHCR }}:${{ needs.set-tag.outputs.tag }}-arm64

  # ------------------------
  # 3a. 跳过构建时立即合并 manifest
  # ------------------------
  manifest-skip:
    needs: [ set-tag, check-images ]
    if: needs.check-images.outputs.skip_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}
      - uses: docker/setup-buildx-action@v2

      - name: Create & push DockerHub manifest
        run: |
          TAG=${{ needs.set-tag.outputs.tag }}
          docker buildx imagetools create --tag ${{ env.REPO_DOCKERHUB }}:$TAG \
            ${{ env.REPO_DOCKERHUB }}:$TAG-amd64 \
            ${{ env.REPO_DOCKERHUB }}:$TAG-arm64

      - name: Create & push GHCR manifest
        run: |
          TAG=${{ needs.set-tag.outputs.tag }}
          docker buildx imagetools create --tag ${{ env.REPO_GHCR }}:$TAG \
            ${{ env.REPO_GHCR }}:$TAG-amd64 \
            ${{ env.REPO_GHCR }}:$TAG-arm64

  # ------------------------
  # 3b. 构建后合并 manifest
  # ------------------------
  manifest-after-build:
    needs: [ set-tag, check-images, build-amd64, build-arm64 ]
    if: needs.check-images.outputs.skip_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}
      - uses: docker/setup-buildx-action@v2

      - name: Create & push DockerHub manifest
        run: |
          TAG=${{ needs.set-tag.outputs.tag }}
          docker buildx imagetools create --tag ${{ env.REPO_DOCKERHUB }}:$TAG \
            ${{ env.REPO_DOCKERHUB }}:$TAG-amd64 \
            ${{ env.REPO_DOCKERHUB }}:$TAG-arm64

      - name: Create & push GHCR manifest
        run: |
          TAG=${{ needs.set-tag.outputs.tag }}
          docker buildx imagetools create --tag ${{ env.REPO_GHCR }}:$TAG \
            ${{ env.REPO_GHCR }}:$TAG-amd64 \
            ${{ env.REPO_GHCR }}:$TAG-arm64

# ===========================================================
# ⭐ 新增部分：导出阶段（无论是否构建都执行）
# ===========================================================

  # ------------------------
  # 4. 合流节点：保证 export 一定执行
  # ------------------------
  manifest-final:
    needs: [manifest-after-build, manifest-skip]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - run: echo "Manifest completed."

  # ------------------------
  # 5a. 在 amd64 平台导出产物
  # ------------------------
  export-amd64:
    needs: [set-tag, manifest-final]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v2
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}
          registry: ghcr.io
      - name: Pull amd64 image
        run: |
          TAG=$(echo "${{ needs.set-tag.outputs.tag }}" | tr -d '\n\r')
          IMAGE="${{ env.REPO_GHCR }}:${TAG}-amd64"
          echo "Pulling image $IMAGE"
          docker pull "$IMAGE"
      - name: Extract artifacts
        run: |
          TAG=$(echo "${{ needs.set-tag.outputs.tag }}" | tr -d '\n\r')
          IMAGE="${{ env.REPO_GHCR }}:${TAG}-amd64"
          echo "Using TAG=$TAG, IMAGE=$IMAGE"
          mkdir -p ammds-amd64-backend ammds-amd64-frontend
  
          # 排除文件
          EXCLUDE_FILES=("poweredby.png" "system_noindex_logo.png")
          EXCLUDE_ARGS=()
          for f in "${EXCLUDE_FILES[@]}"; do
              EXCLUDE_ARGS+=(--exclude="./$f")
          done
  
          # 创建容器
          CID=$(docker create --platform linux/amd64 "$IMAGE")
          echo "Container ID: $CID"
  
          # 拷贝后端
          docker cp "$CID":/ammds/ammds ./ammds-amd64-backend/
  
          # 启动容器
          docker start "$CID"
  
          # 导出前端，安全传递排除参数
          docker exec "$CID" tar -C /usr/share/nginx/html "${EXCLUDE_ARGS[@]}" -cf - . | tar -C ./ammds-amd64-frontend -xf -
  
          # 清理容器
          docker rm "$CID"
  
          # 打包产物
          tar -czf ammds-amd64-backend.tar.gz -C ammds-amd64-backend .
          tar -czf ammds-amd64-frontend.tar.gz -C ammds-amd64-frontend .
      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ammds-amd64-backend.tar.gz
            ammds-amd64-frontend.tar.gz
  
  # ------------------------
  # 5b. 在 arm64 平台导出产物
  # ------------------------
  export-arm64:
    needs: [set-tag, manifest-final]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v2
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}
          registry: ghcr.io
      - name: Pull arm64 image
        run: |
          TAG=$(echo "${{ needs.set-tag.outputs.tag }}" | tr -d '\n\r')
          IMAGE="${{ env.REPO_GHCR }}:${TAG}-arm64"
          echo "Pulling image $IMAGE"
          docker pull --platform linux/arm64 "$IMAGE"
      - name: Extract artifacts
        run: |
          TAG=$(echo "${{ needs.set-tag.outputs.tag }}" | tr -d '\n\r')
          IMAGE="${{ env.REPO_GHCR }}:${TAG}-arm64"
          echo "Using TAG=$TAG, IMAGE=$IMAGE"
          mkdir -p ammds-arm64-backend ammds-arm64-frontend
  
          EXCLUDE_FILES=("poweredby.png" "system_noindex_logo.png")
          EXCLUDE_ARGS=()
          for f in "${EXCLUDE_FILES[@]}"; do
              EXCLUDE_ARGS+=(--exclude="./$f")
          done
  
          CID=$(docker create --platform linux/arm64 "$IMAGE")
          echo "Container ID: $CID"
  
          docker cp "$CID":/ammds/ammds ./ammds-arm64-backend/
  
          docker start "$CID"
          docker exec "$CID" tar -C /usr/share/nginx/html "${EXCLUDE_ARGS[@]}" -cf - . | tar -C ./ammds-arm64-frontend -xf -
          docker rm "$CID"
  
          tar -czf ammds-arm64-backend.tar.gz -C ammds-arm64-backend .
          tar -czf ammds-arm64-frontend.tar.gz -C ammds-arm64-frontend .
      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ammds-arm64-backend.tar.gz
            ammds-arm64-frontend.tar.gz

