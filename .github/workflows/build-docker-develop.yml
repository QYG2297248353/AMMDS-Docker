name: Build & Publish Develop Docker Images

on:
  push:
    branches: [ release ]
  release:
    types: [ created ]
  workflow_dispatch:
    inputs:
      ref_name:
        description: '镜像标签（如 v1.6.10）'
        required: true
        default: 'v1.0.0'

env:
  REPO_DOCKERHUB: docker.io/qyg2297248353/ammds
  REPO_GHCR:      ghcr.io/qyg2297248353/ammds

# =====================================================
# 1️⃣ 统一计算 tag
# =====================================================
jobs:
  set-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.calc.outputs.tag }}
    steps:
      - id: calc
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.ref_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            BRANCH=${GITHUB_REF#refs/heads/}
            echo "tag=$BRANCH" >> $GITHUB_OUTPUT
          fi

# =====================================================
# 2️⃣ amd64 native 构建
# =====================================================
  build-amd64:
    needs: set-tag
    if: >
      github.event_name != 'release' ||
      github.event.release.target_commitish == 'develop'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v3

      - name: Checkout source repo (with LFS)
        run: |
          git lfs install --skip-smudge
          git clone https://x-access-token:${{ secrets.GITHUBTOKEN }}@github.com/QYG2297248353/AMMDS.git source
          cd source && git lfs pull --exclude="*"

      - uses: docker/setup-buildx-action@v2

      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}

      - name: Build & push amd64 native image
        uses: docker/build-push-action@v4
        with:
          context: ./source
          file: ./source/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REPO_DOCKERHUB }}:${{ needs.set-tag.outputs.tag }}-amd64
            ${{ env.REPO_GHCR }}:${{ needs.set-tag.outputs.tag }}-amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

# =====================================================
# 3️⃣ arm64 runtime 构建
# =====================================================
  build-arm64:
    needs: [ set-tag, build-amd64 ]
    if: >
      github.event_name != 'release' ||
      github.event.release.target_commitish == 'develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Checkout source repo (with LFS)
        run: |
          git lfs install --skip-smudge
          git clone https://x-access-token:${{ secrets.GITHUBTOKEN }}@github.com/QYG2297248353/AMMDS.git source
          cd source && git lfs pull --exclude="*"

      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v2

      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}

      - name: Build & push arm64 runtime image
        uses: docker/build-push-action@v4
        with:
          context: ./source
          file: ./source/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.REPO_DOCKERHUB }}:${{ needs.set-tag.outputs.tag }}-arm64
            ${{ env.REPO_GHCR }}:${{ needs.set-tag.outputs.tag }}-arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

# =====================================================
# 4️⃣ manifest 合并
# =====================================================
  manifest:
    needs: [ set-tag, build-amd64, build-arm64 ]
    if: >
      github.event_name != 'release' ||
      github.event.release.target_commitish == 'develop'
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}

      - uses: docker/setup-buildx-action@v2

      - name: Create DockerHub manifest
        run: |
          TAG=${{ needs.set-tag.outputs.tag }}
          docker buildx imagetools create \
            --tag ${{ env.REPO_DOCKERHUB }}:$TAG \
            ${{ env.REPO_DOCKERHUB }}:$TAG-amd64 \
            ${{ env.REPO_DOCKERHUB }}:$TAG-arm64

      - name: Create GHCR manifest
        run: |
          TAG=${{ needs.set-tag.outputs.tag }}
          docker buildx imagetools create \
            --tag ${{ env.REPO_GHCR }}:$TAG \
            ${{ env.REPO_GHCR }}:$TAG-amd64 \
            ${{ env.REPO_GHCR }}:$TAG-arm64

# =====================================================
# 5️⃣ 导出产物
# =====================================================
  export:
    needs: [ set-tag, manifest ]
    if: >
      github.event_name != 'release' ||
      github.event.release.target_commitish == 'develop'
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}

      - name: Export amd64 backend
        run: |
          TAG=${{ needs.set-tag.outputs.tag }}
          IMAGE=${{ env.REPO_GHCR }}:$TAG-amd64
          docker pull "$IMAGE"
          CID=$(docker create --platform linux/amd64 "$IMAGE")
          mkdir -p out/amd64
          docker cp "$CID":/ammds/ammds out/amd64/
          docker rm "$CID"
          tar -czf ammds-amd64-backend.tar.gz -C out/amd64 .

      - name: Export arm64 backend
        run: |
          TAG=${{ needs.set-tag.outputs.tag }}
          IMAGE=${{ env.REPO_GHCR }}:$TAG-amd64
          docker pull "$IMAGE"
          CID=$(docker create --platform linux/amd64 "$IMAGE")
          mkdir -p out/arm64
          docker cp "$CID":/ammds/ammds out/arm64/
          docker rm "$CID"
          tar -czf ammds-arm64-backend.tar.gz -C out/arm64 .

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ammds-amd64-backend.tar.gz
            ammds-arm64-backend.tar.gz
