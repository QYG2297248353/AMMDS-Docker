@{
    var vm = (Afdian.Action.ViewModels.AfdianViewModel)Model;
    string meUserId = "e6bacc3e730d11ea857252540025c377";
    string currentPlanId = "cd7b3152731011eabcd452540025c377";

    // 1. 过滤订单：只留本 repo 计划、支付成功、排除自己
    var orders = vm.Order.data.list
        .Where(o => o.plan_id == currentPlanId && o.status == 2 && o.user_id != meUserId)
        .ToList();

    // 2. 聚合每个赞助者
    var sponsors = vm.Sponsor.data.list
        .Where(s => s.user.user_id != meUserId)
        .Select(s => {
            var so = orders.Where(o => o.user_id == s.user.user_id).ToList();
            double totalAmt = so.Sum(o => Convert.ToDouble(o.total_amount));
            var lastOrder = so
                .OrderByDescending(o => o.out_trade_no)  // 假设 trade_no 可近似时间
                .FirstOrDefault();
            return new {
                Id     = s.user.user_id,
                Name   = s.user.name,
                Avatar = s.user.avatar + "?imageView2/1/w/120/h/120",
                Count  = so.Count,
                LatestRemark = lastOrder?.remark ?? "",
                LastTime     = lastOrder?.out_trade_no ?? ""
            };
        })
        .Where(x => x.Count > 0)  // 只留有过赞助的
        .OrderByDescending(x => x.Count)      // 先按次数（或改成 totalAmt）
        .ThenByDescending(x => x.LastTime)    // 同次数按支付时间
        .ToList();
}

@if (!sponsors.Any())
{
    <text>
暂无赞助者，快来做第一位吧！  
    </text>
}
else
{
    // 顶部头像墙
    <text>
## 💝 感谢以下赞助者  

<p>
@foreach (var s in sponsors)
{
    <a href="https://afdian.net/u/@s.Id" title="@s.Name" target="_blank" style="margin:0 4px;">
        <img src="@s.Avatar" width="40" height="40" style="border-radius:50%;" alt="@s.Name" />
    </a>
}
</p>
    </text>

    // 折叠详细表格
    <text>
<details>
<summary>点击查看详细赞助信息（@sponsors.Count() 人）</summary>

| 头像 | 昵称 | 赞助次数 | 最新留言 |
| ---- | ---- | -------- | -------- |
@foreach (var s in sponsors)
{
    // 截断留言
    var rm = s.LatestRemark.Length > 20 ? s.LatestRemark.Substring(0,20) + "..." : s.LatestRemark;
    <text>
| <img src="@s.Avatar" width="30" height="30" style="border-radius:50%;" /> | [@s.Name](https://afdian.net/u/@s.Id) | @s.Count | @(!string.IsNullOrWhiteSpace(rm) ? rm : "—") |
    </text>
}
</details>
    </text>
}
