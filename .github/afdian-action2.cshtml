@{
    var vm = (Afdian.Action.ViewModels.AfdianViewModel)Model;
    string meUserId       = "e6bacc3e730d11ea857252540025c377";
    string currentPlanId  = "cd7b3152731011eabcd452540025c377";

    // 1. è¿‡æ»¤ï¼šåªè¦æœ¬ä»“åº“è®¡åˆ’ã€äº¤æ˜“æˆåŠŸã€æ’é™¤è‡ªå·±
    var validOrders = vm.Order.data.list
        .Where(o => o.plan_id == currentPlanId && o.status == 2 && o.user_id != meUserId)
        .ToList();

    var validSponsors = vm.Sponsor.data.list
        .Where(s => s.user.user_id != meUserId)
        .ToList();

    // 2. èšåˆåŠæ’åº
    var sorted = validSponsors
        .Select(s => {
            var orders = validOrders.Where(o => o.user_id == s.user.user_id).ToList();
            // æœ€åä¸€æ¬¡æ”¯ä»˜æ—¶é—´ï¼ˆå‡è®¾ out_trade_no å‰14ä½ä¸º yyyyMMddHHmmssï¼‰
            DateTime lastTime = orders.Any()
                ? DateTime.ParseExact(orders.Max(o => o.out_trade_no).Substring(0, 14),
                                      "yyyyMMddHHmmss",
                                      null)
                : DateTime.MinValue;
            return new {
                Sponsor    = s,
                OrderCount = orders.Count,
                LastTime   = lastTime,
                TotalAmt   = orders.Sum(o => Convert.ToDouble(o.total_amount))
            };
        })
        .Where(x => x.OrderCount > 0)                // åªä¿ç•™è‡³å°‘ä¸€æ¬¡èµåŠ©
        .OrderByDescending(x => x.TotalAmt)          // æŒ‰æ€»é‡‘é¢é™åº
        .ThenByDescending(x => x.LastTime)           // åŒé‡‘é¢åˆ™æŒ‰æœ€æ–°æ—¶é—´
        .ToList();
}

@if (!sorted.Any())
{
    <text>
> æš‚æ— èµåŠ©è€…ï¼Œæ¬¢è¿ç¬¬ä¸€ä¸ªæ”¯æŒï¼  
    </text>
}
else
{
    <text>
## ğŸ’ æ„Ÿè°¢ä»¥ä¸‹èµåŠ©è€…

<p align="center">
@foreach (var item in sorted)
{
    <a href="https://afdian.net/u/@item.Sponsor.user.user_id" title="@item.Sponsor.user.name" target="_blank" style="margin:0 6px;">
        <img src="@item.Sponsor.user.avatar?imageView2/1/w/120/h/120" width="50" height="50" style="border-radius:50%;" alt="@item.Sponsor.user.name" />
    </a>
}
</p>
</text>

    <text>
<details>
<summary>ğŸ‰ ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†èµåŠ©ä¿¡æ¯ï¼ˆ@sorted.Count() äººï¼‰</summary>

| å¤´åƒ | æ˜µç§° | æ”¯æŒæ¬¡æ•° | æœ€æ–°ç•™è¨€ |
| ---- | ---- | -------- | -------- |
@foreach (var item in sorted)
{
    // å–æœ€æ–°ç•™è¨€å¹¶æˆªæ–­
    var remark = vm.Order.data.list
        .Where(o => o.user_id == item.Sponsor.user.user_id && !string.IsNullOrWhiteSpace(o.remark))
        .OrderByDescending(o => DateTime.ParseExact(o.out_trade_no.Substring(0,14),"yyyyMMddHHmmss",null))
        .Select(o => o.remark)
        .FirstOrDefault() ?? "â€”";
    var shortRm = remark.Length > 20 ? remark.Substring(0,20) + "..." : remark;
    <text>
| <img src="@item.Sponsor.user.avatar?imageView2/1/w/120/h/120" width="30" height="30" style="border-radius:50%;" /> | [@item.Sponsor.user.name](https://afdian.net/u/@item.Sponsor.user.user_id) | @item.OrderCount | @shortRm |
    </text>
}
</details>
    </text>
}
