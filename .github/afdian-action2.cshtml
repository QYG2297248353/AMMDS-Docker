@{
    var vm = (Afdian.Action.ViewModels.AfdianViewModel)Model;
    string meUserId = "e6bacc3e730d11ea857252540025c377";
    string currentPlanId = "cd7b3152731011eabcd452540025c377";

    // 1. è¿‡æ»¤è®¢å•ï¼šåªç•™æœ¬ repo è®¡åˆ’ã€æ”¯ä»˜æˆåŠŸã€æ’é™¤è‡ªå·±
    var orders = vm.Order.data.list
        .Where(o => o.plan_id == currentPlanId && o.status == 2 && o.user_id != meUserId)
        .ToList();

    // 2. èšåˆæ¯ä¸ªèµåŠ©è€…
    var sponsors = vm.Sponsor.data.list
        .Where(s => s.user.user_id != meUserId)
        .Select(s => {
            var so = orders.Where(o => o.user_id == s.user.user_id).ToList();
            double totalAmt = so.Sum(o => Convert.ToDouble(o.total_amount));
            var lastOrder = so
                .OrderByDescending(o => o.out_trade_no)  // å‡è®¾ trade_no å¯è¿‘ä¼¼æ—¶é—´
                .FirstOrDefault();
            return new {
                Id     = s.user.user_id,
                Name   = s.user.name,
                Avatar = s.user.avatar + "?imageView2/1/w/120/h/120",
                Count  = so.Count,
                LatestRemark = lastOrder?.remark ?? "",
                LastTime     = lastOrder?.out_trade_no ?? ""
            };
        })
        .Where(x => x.Count > 0)  // åªç•™æœ‰è¿‡èµåŠ©çš„
        .OrderByDescending(x => x.Count)      // å…ˆæŒ‰æ¬¡æ•°ï¼ˆæˆ–æ”¹æˆ totalAmtï¼‰
        .ThenByDescending(x => x.LastTime)    // åŒæ¬¡æ•°æŒ‰æ”¯ä»˜æ—¶é—´
        .ToList();
}

@if (!sponsors.Any())
{
    <text>
æš‚æ— èµåŠ©è€…ï¼Œå¿«æ¥åšç¬¬ä¸€ä½å§ï¼  
    </text>
}
else
{
    // é¡¶éƒ¨å¤´åƒå¢™
    <text>
## ğŸ’ æ„Ÿè°¢ä»¥ä¸‹èµåŠ©è€…  

<p>
@foreach (var s in sponsors)
{
    <a href="https://afdian.net/u/@s.Id" title="@s.Name" target="_blank" style="margin:0 4px;">
        <img src="@s.Avatar" width="40" height="40" style="border-radius:50%;" alt="@s.Name" />
    </a>
}
</p>
    </text>

    // æŠ˜å è¯¦ç»†è¡¨æ ¼
    <text>
<details>
<summary>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†èµåŠ©ä¿¡æ¯ï¼ˆ@sponsors.Count() äººï¼‰</summary>

| å¤´åƒ | æ˜µç§° | èµåŠ©æ¬¡æ•° | æœ€æ–°ç•™è¨€ |
| ---- | ---- | -------- | -------- |
@foreach (var s in sponsors)
{
    // æˆªæ–­ç•™è¨€
    var rm = s.LatestRemark.Length > 20 ? s.LatestRemark.Substring(0,20) + "..." : s.LatestRemark;
    <text>
| <img src="@s.Avatar" width="30" height="30" style="border-radius:50%;" /> | [@s.Name](https://afdian.net/u/@s.Id) | @s.Count | @(!string.IsNullOrWhiteSpace(rm) ? rm : "â€”") |
    </text>
}
</details>
    </text>
}
