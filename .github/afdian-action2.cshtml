@{
    var viewModel = (Afdian.Action.ViewModels.AfdianViewModel)@Model;
    string meUserId = "e6bacc3e730d11ea857252540025c377";
    string currentRepoPlanId = "cd7b3152731011eabcd452540025c377";

    // 筛选订单
    var orders = viewModel.Order.data.list
        .Where(m => m.plan_id == currentRepoPlanId && m.status == 2 && m.user_id != meUserId)
        .ToList();

    // 构建赞助者数据
    var sponsors = viewModel.Sponsor.data.list
        .Where(s => s.user.user_id != meUserId)
        .Select(s => {
            var sponsorOrders = orders.Where(o => o.user_id == s.user.user_id).ToList();
            double total = sponsorOrders.Sum(o => Convert.ToDouble(o.total_amount));
            int count = sponsorOrders.Count();
            string latestRemark = sponsorOrders
                .Where(o => !string.IsNullOrEmpty(o.remark))
                .OrderByDescending(o => o.out_trade_no) // 或使用 create_time 字段
                .Select(o => o.remark)
                .FirstOrDefault() ?? "";

            string latestTime = sponsorOrders
                .OrderByDescending(o => o.out_trade_no)
                .Select(o => o.out_trade_no)
                .FirstOrDefault();

            return new {
                userId = s.user.user_id,
                name = s.user.name,
                avatar = s.user.avatar,
                total = total,
                count = count,
                remark = latestRemark,
                latestTime = latestTime
            };
        })
        .Where(s => s.total > 0)
        .OrderByDescending(s => s.total)
        .ThenByDescending(s => s.latestTime) // 模拟时间排序
        .ToList();
}

<!-- 头像墙 -->
<p>
@foreach (var s in sponsors)
{
    <a href="https://afdian.net/u/@s.userId" title="@s.name" target="_blank" style="margin-right:6px;">
        <img src="@s.avatar?imageView2/1/w/60/h/60" width="40" height="40" style="border-radius:50%;">
    </a>
}
</p>

<details>
<summary>点击展开详细赞助者信息</summary>

<table>
  <thead>
    <tr>
      <th>头像</th>
      <th>昵称</th>
      <th>赞助次数</th>
      <th>总金额</th>
      <th>留言</th>
    </tr>
  </thead>
  <tbody>
@foreach (var s in sponsors)
{
<tr>
  <td><img src="@s.avatar?imageView2/1/w/60/h/60" width="40" height="40" style="border-radius:50%;"/></td>
  <td><a href="https://afdian.net/u/@s.userId" target="_blank">@s.name</a></td>
  <td>@s.count</td>
  <td>￥@string.Format("{0:0.##}", s.total)</td>
  <td>@(s.remark.Length > 20 ? s.remark.Substring(0, 20) + "..." : s.remark)</td>
</tr>
}
  </tbody>
</table>
</details>
